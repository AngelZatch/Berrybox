function onYouTubeIframeAPIReady(){player=new YT.Player("player",{height:"85%",width:"60%",videoId:"",events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}}),resizeElements()}function addEntry(e,s,t){$.post("functions/post_history.php",{url:s,box_token:e,source:t}).done(function(e){if(console.log(e),"playlist"!=t)switch(e){case"ok":$("#body-chat").append("<p class='system-message system-success'><span class='glyphicon glyphicon-ok-sign'></span> "+language_tokens.song_submit_success+"</p>");break;case"error":$("#body-chat").append("<p class='system-message system-alert'><span class='glyphicon glyphicon-exclamation-sign'></span> "+language_tokens.invalid_link+"</p>");break;case"info":$("#body-chat").append("<p class='system-message system-alert'><span class='glyphicon glyphicon-exclamation-sign'></span> "+language_tokens.need_info+"</p>");break;default:requestCompletion(e)}return $("#body-chat").scrollTop($("#body-chat")[0].scrollHeight),e})}function getActiveWatchers(e){$.get("functions/get_user_list.php",{box_token:e}).done(function(e){var s=JSON.parse(e);$(".rank-container").empty();for(var t=0;t<s.length;t++){var o="";o+="<div class='row' id='row-"+s[t].pseudo+"'>",o+="<p class='col-xs-10'>",o+=s[t].pseudo,o+="</p>",s[t].pseudo!=user_name&&2==user_power&&(o+="<p class='col-xs-1' title='"+language_tokens.transfer_box+"'><span class='glyphicon glyphicon-transfer button-glyph transfer-box' data-user='"+s[t].pseudo+"'></span></p>"),o+="</div>",$("#rank-"+s[t].power+"-container").append(o)}$("#watch-count").text(" "+s.length)})}function getBoxDetails(e){return $.get("functions/get_box_details.php",{box_token:e})}function getBoxToken(){return/([a-z0-9]+$)/i.exec(document.location.href)[0]}function getNext(e,s){if(1==e){var t="{skip}";sendMessage(s,4,3,t)}2==window.user_power?(console.log("Fetching next video..."),$.post("functions/get_next.php",{box_token:s,user_power:window.user_power,lastPlayed:sessionStorage.getItem("currently-playing")}).done(function(e){e||setTimeout(getNext,5e3,!1,s)})):$(".sync-message").append("<span class='glyphicon glyphicon-refresh' title='"+language_tokens.synchronizing+"'></span> <span class='hidden-xs hidden-sm hidden-md'>"+language_tokens.synchronizing+"</span>")}function joinBox(e,s){return $.post("functions/join_box.php",{box_token:e,user_token:s})}function loadPlaylist(e,s){s&&clearTimeout(refresh_playlist_timer),"none"!=$("#song-list").css("display")&&($("#playlist-filter").is(":focus")||$.post("functions/get_history.php",{box_token:e}).done(function(e){var s=JSON.parse(e),t=0,o=0;$("#body-song-list").empty();for(var n=-1,a=0;a<s.length;a++){var i="",l=s[a].videoName.replace(/'/g,"&#39");if(n!=s[a].videoStatus)switch(s[a].videoStatus){case"0":case"3":if(0==a){var r="<p class='list-rank' id='list-upcoming'>"+language_tokens.sl_upcoming+"</p>";$("#body-song-list").append(r)}break;case"1":i+="<p class='list-rank'>"+language_tokens.now_playing+"</p>";break;case"2":i+="<p class='list-rank' id='list-played'>"+language_tokens.sl_played+"</p>"}var c;if(2==s[a].videoStatus)i+="<div class='row playlist-entry song-played'>",c=10,o++;else if(1==s[a].videoStatus)i+="<div class='row playlist-entry song-playing'>",c=11;else if(3==s[a].videoStatus)i+="<div class='row playlist-entry song-ignored'>",c=10;else{var i="<div class='row playlist-entry song-upcoming'>";t++,c=10}2!=window.user_power&&3!=window.user_power&&c++,(2==window.user_power||3==window.user_power)&&("0"==s[a].videoStatus||"3"==s[a].videoStatus)&&(c-=2,i+="<div class='col-xs-1'>",0!=a&&(i+="<span class='glyphicon glyphicon-arrow-up button-glyph swap-order' id='up-"+s[a].entry+"' data-order='"+s[a].order+"' title='"+language_tokens.song_up+"'></span>"),i+="</div>",i+="<div class='col-xs-1'>",(0==s[a+1].videoStatus||3==s[a+1].videoStatus)&&(i+="<span class='glyphicon glyphicon-arrow-down button-glyph swap-order' id='down-"+s[a].entry+"' data-order='"+s[a].order+"' title='"+language_tokens.song_down+"'></span>"),i+="</div>"),i+="<div class='col-xs-"+c+"'>",i+="<p class='song-list-line'><a href='https://www.youtube.com/watch?v="+s[a].videoLink+"' target='_blank' title='"+l+"'>"+s[a].videoName+"</a></p></div>",1==window.room_state&&((2==window.user_power||3==window.user_power)&&(i+="<div class='col-xs-1'>",1==s[a].pending&&(i+="<span class='glyphicon glyphicon-pencil button-glyph' onClick=requestCompletion("+s[a].index+")></span>"),i+="</div>",i+="<div class='col-xs-1'>",0==s[a].videoStatus?i+="<span class='glyphicon glyphicon-ban-circle button-glyph ignore-video' id='ignore-"+s[a].entry+"' data-target='"+s[a].entry+"'></span>":3==s[a].videoStatus&&(i+="<span class='glyphicon glyphicon-ok-circle button-glyph reinstate-video' id='reinstate-"+s[a].entry+"' data-target='"+s[a].entry+"'></span>")),2==s[a].videoStatus&&-1!=user_token&&(2==window.room_submission_rights&&1!=user_power||1==window.room_submission_rights)&&(i+="<span class='glyphicon glyphicon-repeat button-glyph quick-requeue' id='quick-requeue-"+s[a].entry+"' data-target='"+s[a].entry+"'></span>"),i+="</div>"),i+="</div>",n=s[a].videoStatus,$("#body-song-list").append(i)}$("#list-upcoming").append(" ("+t+")"),$("#list-played").append(" ("+o+")")}),-1!=user_token&&($("#likes-filter").is(":focus")||$.get("functions/get_likes.php",{user_token:user_token}).done(function(e){var s=JSON.parse(e);$("#body-song-likes").empty();for(var t=0;t<s.length;t++){var o="",n=s[t].video_name.replace(/'/g,"&#39");o+="<div class='row likes-entry'>",o+="<div class='col-xs-11'>",o+="<p class='song-list-line'>",o+="<span class='glyphicon glyphicon-"+s[t].key_icon+" emotion-"+s[t].key_mood+"'></span> ",o+="<a href='"+s[t].video_link+"' target='_blank' title='"+n+"'>"+s[t].video_name+"</a></p></div>",1==window.room_state&&(o+="<span class='glyphicon glyphicon-circle-arrow-right button-glyph quick-submit' id='quick-submit-"+s[t].video_id+"' data-target='"+s[t].video_id+"'></span>"),o+="</div>",$("#body-song-likes").append(o)}})),refresh_playlist_timer=setTimeout(loadPlaylist,8e3,e,!1))}function onPlayerReady(){var e=getBoxToken();sessionStorage.setItem("currently-playing",""),synchronize(e)}function onPlayerStateChange(e){var s=getBoxToken();0!=window.autoplay&&e.data==YT.PlayerState.ENDED&&getNext(!1,s),e.data==YT.PlayerState.PLAYING&&-1!=user_token&&fetchMood(user_token,sessionStorage.getItem("currently-playing")),window.playerStatus=e.data}function playSong(e,s,t,o,n){var a=getBoxToken();if(0!=o){var i=moment.utc(o).add(7,"s"),l=moment(i).local(),r=Math.round(moment().diff(l)/1e3);0>r&&(r=0),player.loadVideoById(s,r)}else player.loadVideoById(s,0);if($(".sync-message").empty(),sessionStorage.setItem("currently-playing",e),document.title=t+" | Berrybox",$(".currently-name").empty(),$(".currently-name").html(t),$("#video-submitter").html(n),user_token==box_details.room_creator&&(0==o||3>=r)){var c="{now_playing}"+t;sendMessage(a,4,2,c),$.post("functions/register_song.php",{index:e})}displayMoodVotes(e)}function refreshWatchers(e){var s=parseInt($("#watch-count").text());if(e.arrival&&(s++,$("#watch-count").text(" "+s),e.user)){var t="<div class='row' id='row-"+e.user+"'>";t+="<p class='col-xs-10'>",t+=e.user,t+="</p>",2==window.user_power&&(t+="<p class='col-xs-1' title='"+language_tokens.transfer_box+"'><span class='glyphicon glyphicon-transfer button-glyph transfer-box' data-user='"+e.user+"'></span></p>"),t+="</div>",$("#rank-"+e.user_power+"-container").append(t)}e.departure&&(s--,$("#watch-count").text(" "+s),e.user&&$("#row-"+e.user).remove())}function renderBoxState(e){getBoxToken();if(e.room_name&&$("#room-title").text(e.room_name),e.stat_visitors&&($(".creator-views").text(e.stat_visitors),$(".creator-followers").text(e.stat_followers)),e.user_pseudo&&e.user_pseudo!=$("#box-creator-link").text()){if(e.user_pseudo==window.user_name){if($(".btn-toggle-follow").remove(),$(".playlist-actions").is(":empty")){console.log("loading skip buttons");var s="<button class='btn btn-default btn-admin btn-skip col-xs-6'><span class='glyphicon glyphicon-step-forward resize-lg'></span> <span class='hidden-xs hidden-sm hidden-md'> "+language_tokens.skip+"</span></button>";s+="<button class='btn btn-default btn-admin shuffle-playlist col-xs-6'><span class='glyphicon glyphicon-random resize-lg'></span> <span class='hidden-xs hidden-sm hidden-md'> "+language_tokens.shuffle+"</span></button>",$(".playlist-actions").append(s)}var s="<div class='admin-options'>";s+="<div role='separator' class='divider options-divider'></div>",s+="<p class='options-title'>"+language_tokens.creator_options+"</p>",s+="<div class='room-option'>",s+="<p class='option-title'>"+language_tokens.play_type+"</p>",s+="<span class='tip'>"+language_tokens.play_type_tip+"</span>",s+="<div class='row'>",s+="<div class='col-lg-6'>",s+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-automatic' data-field='room_play_type' data-value='1' data-twin='select-manual'>",s+="<span class='glyphicon glyphicon-play-circle'></span> ",s+=language_tokens.auto_play,s+="</span>",s+="</div>",s+="<div class='col-lg-6'>",s+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-manual' data-field='room_play_type' data-value='2' data-twin='select-automatic'>",s+="<span class='glyphicon glyphicon-hourglass'></span> ",s+=language_tokens.manual_play,s+="</span>",s+="</div>",s+="</div>",s+="</div>",s+="<div class='room-option'>",s+="<p class='option-title'>"+language_tokens.submit_type+"</p>",s+="<span class='tip'>"+language_tokens.submit_type_tip+"</span>",s+="<div class='row'>",s+="<div class='col-lg-6'>",s+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-everyone' data-field='room_submission_rights' data-value='1' data-twin='select-mods-only'>",s+="<span class='glyphicon glyphicon-ok-sign'></span> ",s+=language_tokens.submit_all,s+="</span>",s+="</div>",s+="<div class='col-lg-6'>",s+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-mods-only' data-field='room_submission_rights' data-value='2' data-twin='select-everyone'>",s+="<span class='glyphicon glyphicon-ok-circle'></span> ",s+=language_tokens.submit_mod,s+="</span>",s+="</div>",s+="</div>",s+="</div>",s+="<div class='room-option'>",s+="<p class='option-title'>"+language_tokens.room_protection+"</p>",s+="<span class='tip'>"+language_tokens.protection_tip+"</span>",s+="<div class='row'>",s+="<div class='col-lg-6'>",s+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-public' data-field='room_protection' data-value='1' data-twin='select-private'>",s+="<span class='glyphicon glyphicon-volume-up'></span> ",s+=language_tokens.level_public,s+="</span>",s+="</div>",s+="<div class='col-lg-6'>",s+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-private' data-field='room_protection' data-value='2' data-twin='select-public'>",s+="<span class='glyphicon glyphicon-headphones'></span> ",s+=language_tokens.level_private,s+="</span>",s+="</div>",s+="</div>",s+="</div>",s+="<div class='room-option'>",s+="<p class='option-title'>"+language_tokens.room_params+"</p>",s+="<span class='tip'>"+language_tokens.room_params_tip+"</span>",s+="<form class='form-horizontal' id='form-box-details'>",s+="<div class='form-group'>",s+="<label for='room_name' class='col-lg-4 control-label'>"+language_tokens.room_name+"</label>",s+="<div class='col-lg-8'><input type='text' name='room_name' class='form-control' id='box-name-input' value='"+e.room_name+"'></div>",s+="</div>",s+="<div class='form-group'>",s+="<label for='room_lang' class='col-lg-4 control-label'>"+language_tokens.speak_lang+"</label>",s+="<div class='col-lg-8'>",s+="<select name='room_lang' id='' class='form-control'>",s+="<option value='en'>"+language_tokens.lang_en+"</option>",s+="<option value='fr'>"+language_tokens.lang_fr+"</option>",s+="<option value='jp'>"+language_tokens.lang_jp+"</option>",s+="</select>",s+="</div>",s+="</div>",s+="<div class='form-group'>",s+="<label form='room_type' class='col-lg-4 control-label'>"+language_tokens.room_type+"</label>",s+="<div class='col-lg-8'>",s+="<select name='room_type' class='form-control' id='type-select'>",$.get("functions/fetch_box_types.php",{box_token:getBoxToken()}).done(function(e){for(var s=JSON.parse(e),t=0;t<s.length;t++)$("#type-select").append($("<option></option>").text(language_tokens[s[t].type]).val(s[t].id))}),s+="</select>",s+="</div>",s+="</div>",s+="<div class='form-group'>",s+="<label form='room_description' class='col-lg-4 control-label'>"+language_tokens.description_limit+"</label>",s+="<div class='col-lg-8'>",s+="<textarea name='room_description' cols='30' rows='5' class='form-control'>"+e.room_description+"</textarea>",s+="</div>",s+="</div>",s+="</form>",s+="<button class='btn btn-primary btn-block' id='save-room-button'>"+language_tokens.save_changes+"</button>",s+="</div>",$(".admin-options").empty(),$("#body-options-list").append(s)}else{$(".admin-options").empty(),$(".playlist-actions").empty();var t="",o="",n="";1==e.following_creator?(t="btn-unfollow btn-active",o="unfollow",n=language_tokens.following+" "+e.user_pseudo):(t="btn-follow",o="follow",n=language_tokens.follow+" "+e.user_pseudo);var a="<button class='btn btn-primary btn-toggle-follow "+t+"' id='box-title-"+o+"' value='"+e.user_pseudo+"'>";if(a+="<span class='glyphicon glyphicon-heart'></span>",a+="<span class='hidden-xs hidden-sm'> ",a+=n,a+="</span>",a+="</button>",0==$(".btn-toggle-follow").length&&$(".creator-stats").prepend(a),0==$(".user-options").length){var s="<div class='user-options'>";s+="<span class='option-title'>"+language_tokens.sync+"</span><br>",s+="<span class='tip'>"+language_tokens.sync_tip+"</span>",s+="<button class='btn btn-default btn-admin btn-block sync-on' id='btn-synchro'><span class='glyphicon glyphicon-refresh'></span> "+language_tokens.sync_on+"</button>",s+="</div>",$("#body-options-list").empty(),$("#body-options-list").append(s)}}$("#box-creator-link").attr("href","user/"+e.user_pseudo),$("#box-creator-link").text(e.user_pseudo),$("#box-creator-picture").attr("src","profile-pictures/"+e.user_pp),$("#box-creator-picture").attr("title",e.user_pseudo+" ("+language_tokens.room_admin+")")}e.room_submission_rights&&(console.log("rendering submission rights"),1==e.room_submission_rights?(window.submission=!0,$(".room-quick-messages").removeClass("col-sm-offset-4"),$(".submission-message").empty(),$("#select-everyone").trigger("activate"),$(".add-link").show()):(1==window.user_power&&($(".add-link").hide(),$(".room-quick-messages").addClass("col-sm-offset-4")),window.submission=!1,$(".submission-message").html("<span class='glyphicon glyphicon-play-circle' title='"+language_tokens.submit_mod+"'></span> <span class='hidden-xs hidden-sm hidden-md'>"+language_tokens.submit_mod+"</span></div>"),$("#select-mods-only").trigger("activate")),window.room_submission_rights=e.room_submission_rights),e.room_protection&&(console.log("rendering protection"),2==e.room_protection?(window.protection=2,$(".protection-message").html("<span class='glyphicon glyphicon-headphones' title='"+language_tokens.level_private+"'></span> <span class='hidden-xs hidden-sm hidden-md'>"+language_tokens.level_private+"</span></div>"),$("#select-private").trigger("activate")):(window.protection=1,$(".protection-message").empty(),$("#select-public").trigger("activate")),window.protection=e.protection),e.room_play_type&&(console.log("rendering play type"),1==e.room_play_type?(window.autoplay=!0,$(".play-message").empty(),$("#select-automatic").trigger("activate")):(window.autoplay=!1,$(".play-message").html("<span class='glyphicon glyphicon-hourglass' title='"+language_tokens.manual_play+"'></span> <span class='hidden-xs hidden-sm hidden-md'>"+language_tokens.manual_play+"</span></div>"),$("#select-manual").trigger("activate")))}function requeueSong(e,s){$.post("functions/requeue_song.php",{box_token:e,video_id:s,user_token:user_token}).done(function(s){console.log(s),$("#body-chat").append("1"==s?"<p class='system-message system-success'><span class='glyphicon glyphicon-ok-sign'></span> "+language_tokens.song_submit_success+"</p>":"<p class='system-message system-warning'></span class='glyphicon glyphicon-question-sign'></span> "+language_tokens.no_fetch+"</p>"),$("#body-chat").scrollTop($("#body-chat")[0].scrollHeight),loadPlaylist(e,!0)})}function shufflePlaylist(e){$.get("functions/playlist_shuffle.php",{box_token:e}).done(function(s){console.log(s),loadPlaylist(e,!0),$("#body-chat").append("<p class='system-message'><span class='glyphicon glyphicon-question-sign'></span> "+language_tokens.playlist_shuffled+"</p>")})}function submitLink(){$(".submit-warning").empty();var e=getBoxToken(),s=$(".url-box").val();if(""!=s){var t=new RegExp(/list=([a-z0-9\-\_]+)\&?/i),o=t.exec(s);if(null!=o){pID=o[1],$(".under-video").append("<div class='modal-body' id='sec-player' style='display:none;'></div>");var n;n=new YT.Player("sec-player",{height:"5",width:"5",videoId:"",events:{onReady:onSecPlayerReady,onStateChange:onSecPlayerStateChange}})}else{var a=new RegExp(/\?v=([a-z0-9\-\_]+)\&?/i),i=a.exec(s);if(null==i){var l=new RegExp(/\.be\/([a-z0-9\-\_]+)\&?/i);i=l.exec(s)}var r=i[1];addEntry(e,r,"solo"),$(".url-box").val("")}}}function synchronize(e){$.post("functions/load_current.php",{box_token:e,user_power:window.user_power}).done(function(s){if(s){var t=JSON.parse(s);playSong(t.index,t.link,t.title,t.timestart,t.submitter)}else console.log("There's no video playing."),getNext(!1,e)})}function toggleVideoInQueue(e,s,t){$.post("functions/toggle_video_in_queue.php",{box_token:e,video_id:s,play_flag:t}).done(function(s){if(0==t){var o="{song_reinstated}"+s;sendMessage(e,4,6,o,null)}if(3==t){var o="{song_ignored}"+s;sendMessage(e,4,5,o,null)}loadPlaylist(e,!0)})}function transferBox(e,s){$.post("functions/transfer_box.php",{box_token:e,user_target:s}).done(function(){var t=s+" "+language_tokens.box_transfered;sendMessage(e,4,1,t);var o={packet_type:"refresh",token:e};conn.publish(e,o)})}function refreshUserState(e,s){$.get("functions/get_user_state.php",{box_token:e,user_token:s}).done(function(s){var t=JSON.parse(s);2==t.room_user_state||3==t.room_user_state?1!=window.playerStatus&&synchronize(e):$(".playlist-actions").empty(),window.user_power=t.room_user_state,console.log("Your power has changed to : "+window.user_power)})}function watchBoxState(e){$.get("functions/get_box_status.php",{box_token:e}).done(function(e){var s=JSON.parse(e);0!=window.room_state&&0==s.room_active&&$("#body-chat").append("<p class='system-message'><span class='glyphicon glyphicon-info-sign'></span> "+language_tokens.room_closing+"</p>")})}var tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);var player,refresh_playlist_timer;$(document).ready(function(){var e=getBoxToken();$.when(joinBox(e,user_token),getUserLang(),getBoxDetails(e)).done(function(s,t,o){window.user_power=s[0],window.language_tokens=JSON.parse(t[0]),window.lang=language_tokens.user_lang,window.box_details=JSON.parse(o[0]),window.room_state=box_details.room_active,getActiveWatchers(e),renderBoxState(box_details),window.conn=new ab.Session("ws://localhost:8080",function(){$("#body-chat").append(2==user_power?"<p class='system-message'>"+language_tokens.welcome_admin+"</p>":"<p class='system-message'>"+language_tokens.welcome+"</p>");var s={packet_type:"user",token:e,user:window.user_name,user_power:window.user_power,arrival:!0};conn.publish(e,s),conn.subscribe(e,function(s,t){switch(t.packet_type){case"chat":console.log("recieved chat message"),displayMessage(t);break;case"sync":console.log("recieved sync packet."),playSong(t.index,t.link,t.title,t.timestart,t.submitter);break;case"box":console.log("recieved box packet."),renderBoxState(t);break;case"user":console.log("recieved user packet."),refreshWatchers(t);break;case"refresh":console.log("recieved refresh packet"),$.when(getBoxDetails(e)).done(function(s){window.box_details=JSON.parse(s),renderBoxState(box_details),getActiveWatchers(e),refreshUserState(e,window.user_token)})}}),conn.subscribe(e+"-"+user_token,function(e,s){switch(s.packet_type){case"box":console.log("recieved private box packet")}})},function(){console.warn("WebSocket connection closed")},{skipSubprotocolCheck:!0}),user_token!=box_details.room_creator?$.post("functions/check_creator.php",{box_token:e}).done(function(e){0==e&&$("#body-chat").append("<p class='system-message system-alert'>"+language_tokens.no_admin+"</p>")}):window.autoplay=1==box_details.room_play_type?!0:!1,setInterval(function(){$.post("functions/refresh_session.php")},18e5),fetchEmotes().done(function(e){var s=JSON.parse(e);window.emotes=[];for(var t=0;t<s.length;t++)emotes.push(s[t].emoteText)}),window.chatHovered=!1,window.showingMoods,window.hidingMoods}),$("#playlist-filter").on("keyup",function(){var e=$(".playlist-entry"),s=$.trim($(this).val()).replace(/ +/g," ").toLowerCase();e.show().filter(function(){var e=$(this).text().replace(/\s+/g," ").toLowerCase();return!~e.indexOf(s)}).hide()}),$("#likes-filter").on("keyup",function(){var e=$(".likes-entry"),s=$.trim($(this).val()).replace(/ +/g," ").toLowerCase();e.show().filter(function(){var e=$(this).text().replace(/\s+/g," ").toLowerCase();return!~e.indexOf(s)}).hide()})}).on("mouseenter",".btn-unfollow",function(){var e=$(this).attr("id"),s=$(this).val();if($(this).hasClass("btn-card"))var t="<span class='glyphicon glyphicon-minus'></span> <span class='hidden-xs hidden-sm'></span>";else var t="<span class='glyphicon glyphicon-minus'></span> <span class='hidden-xs hidden-sm'>"+language_tokens.unfollow+" "+s+"</span>";$("#"+e).html(t),$("#"+e).removeClass("btn-active"),$("#"+e).addClass("btn-danger")}).on("mouseleave",".btn-unfollow",function(){var e=$(this).attr("id"),s=$(this).val();if($(this).hasClass("btn-card"))var t="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'></span>";else var t="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'>"+language_tokens.following+" "+s+"</span>";$("#"+e).html(t),$("#"+e).removeClass("btn-danger"),$("#"+e).addClass("btn-active")}).on("click",".btn-unfollow",function(){var e=$(this).attr("value"),s=$(this).attr("id");$.post("functions/unfollow_user.php",{userFollowing:user_token,userFollowed:e}).done(function(){if($("#"+s).removeClass("btn-active"),$("#"+s).hasClass("btn-card"))var t="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'></span>";else var t="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'>"+language_tokens.follow+" "+e+"</span>";$("#"+s).html(t),$("#"+s).removeClass("btn-danger"),$("#"+s).removeClass("btn-unfollow"),$("#"+s).addClass("btn-follow"),$("#"+s).attr("id",s.substr(0,s.length-6)+"follow"),e==box_details.creator_pseudo&&($("#box-title-unfollow").removeClass("btn-active"),$("#box-title-unfollow").html(t),$("#box-title-unfollow").removeClass("btn-danger"),$("#box-title-unfollow").removeClass("btn-unfollow"),$("#box-title-unfollow").addClass("btn-follow"),$("#box-title-unfollow").attr("id","box-title-follow"))})}).on("click",".btn-follow",function(){var e=$(this).attr("value"),s=$(this).attr("id");$.post("functions/follow_user.php",{userFollowing:user_token,userFollowed:e}).done(function(){if($("#"+s).addClass("btn-active"),$("#"+s).hasClass("btn-card"))var t="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'></span>";else var t="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'>"+language_tokens.following+" "+e+"</span>";$("#"+s).html(t),$("#"+s).removeClass("btn-follow"),$("#"+s).addClass("btn-unfollow"),$("#"+s).attr("id",s.substr(0,s.length-8)+"unfollow"),e==box_details.creator_pseudo&&($("#box-title-follow").addClass("btn-active"),$("#box-title-follow").html(t),$("#box-title-follow").removeClass("btn-follow"),$("#box-title-follow").addClass("btn-unfollow"),$("#box-title-follow").attr("id","box-title-unfollow"))})}).on("click",".play-url",function(){submitLink()}).on("focus",".url-box",function(){$(this).keypress(function(e){13==e.which&&($(this).hasClass("disabled")||submitLink())})}).on("click",".send-info",function(){fillInfo()}).on("click",".cancel-info",function(){var e=$(this).attr("id").substr(12);$("#warning-"+e).remove()}).on("focus",".info-box",function(){$(this).keypress(function(e){13==e.which&&fillInfo()})}).on("click",".color-cube",function(){var e=$(this),s=$(this).attr("id").substr(6,6);$.post("functions/change_color.php",{user_token:user_token,color:s}).done(function(){$(".close").click(),$(".color-cube").removeClass("cube-selected"),e.addClass("cube-selected")})}).on("click",".emotion-container",function(){if($(this).hasClass("selected"))var e=0;else var e=document.getElementById($(this).attr("id")).dataset.mood;voteMood(e,user_token,sessionStorage.getItem("currently-playing"))}).on("click",".ignore-video",function(){var e=document.getElementById($(this).attr("id")).dataset.target,s=getBoxToken();toggleVideoInQueue(s,e,3)}).on("click",".reinstate-video",function(){var e=document.getElementById($(this).attr("id")).dataset.target,s=getBoxToken();toggleVideoInQueue(s,e,0)}).on("click",".toggle-song-list, .toggle-menu-list, .toggle-user-list, .toggle-options-list",function(){var e,s=getBoxToken(),t=$(this).attr("class").split(" ")[4].substr(7),o="0px";if("none"==$("#"+t).css("display"))switch($("#"+t).toggle(),window.innerWidth>1024?e="25%":window.innerWidth<768?(e="0%",o=$("#heading-chat").offset().top+10):e="31.9%",t){case"song-list":loadPlaylist(s,!1),setTimeout(function(){$("#user-list").hide(),$("#menu-list").hide(),$("#options-list").hide()},200),$("#user-list").animate({right:"0px"},200),$("#menu-list").animate({right:"0px"},200),$("#options-list").animate({right:"0px"},200),jQuery(window).width()>992&&$("#currently-playing").animate({width:"68%"},200);break;case"user-list":setTimeout(function(){$("#song-list").hide(),$("#menu-list").hide(),$("#options-list").hide()},200),$("#song-list").animate({right:"0px"},200),$("#menu-list").animate({right:"0px"},200),$("#options-list").animate({right:"0px"},200),jQuery(window).width()>992&&$("#currently-playing").animate({width:"79%"},200);break;case"menu-list":setTimeout(function(){$("#song-list").hide(),$("#user-list").hide(),$("#options-list").hide()},200),$("#song-list").animate({right:"0px"},200),$("#user-list").animate({right:"0px"},200),$("#options-list").animate({right:"0px"},200),jQuery(window).width()>992&&$("#currently-playing").animate({width:"79%"},200);break;case"options-list":setTimeout(function(){$("#song-list").hide(),$("#user-list").hide(),$("#menu-list").hide()},200),$("#song-list").animate({right:"0px"},200),$("#user-list").animate({right:"0px"},200),$("#menu-list").animate({right:"0px"},200),jQuery(window).width()>992&&$("#currently-playing").animate({width:"68%"},200)}else $(this).t=setTimeout(function(){$("#"+t).hide()},200),e="0px",window.innerWidth<768&&(o=window.innerHeight+1),jQuery(window).width()>992&&$("#currently-playing").animate({width:"100%",top:o},200);$("#"+t).animate({right:e,top:o},200)}).on("mouseenter","#body-chat",function(){window.chatHovered=!0}).on("mouseleave","#body-chat",function(){window.chatHovered=!1}).on("click",".quick-submit",function(){var e=getBoxToken(),s=document.getElementById($(this).attr("id")).dataset.target;addEntry(e,s,"solo")}).on("click",".quick-requeue",function(){var e=getBoxToken(),s=document.getElementById($(this).attr("id")).dataset.target;requeueSong(e,s)}).on("click","#save-room-button",function(){var e=getBoxToken();$.when(updateEntry("rooms",$("#form-box-details").serialize(),e)).done(function(s){console.log(s),$("#save-room-button").blur(),$("#save-room-button").text(language_tokens.save_changes_feedback),$("#save-room-button").switchClass("btn-primary","btn-success feedback",200,"easeOutBack");var t={packet_type:"box",token:e,room_name:$("#box-name-input").val()};conn.publish(e,t),setTimeout(function(){$("#save-room-button").switchClass("btn-success feedback","btn-primary",1e3,"easeInQuad"),$("#save-room-button").text(language_tokens.save_changes)},1500)})}).on("keyup",".url-box",function(){var e=$(".url-box").val();if(""!=e){$(".play-url").addClass("disabled"),$(".play-url").attr("disabled","disabled"),$(".play-url").text(language_tokens.searching);var s;s&&clearTimeout(s),s=setTimeout(function(){var s=new RegExp(/list=([a-z0-9\-\_]+)\&?/i),t=s.exec(e);if(null!=t)$(".url-box").blur(),$(".submit-warning").html("<span class='glyphicon glyphicon-ok'></span>"+language_tokens.submit_playlist_link),$(".submit-warning").addClass("system-success"),$(".submit-warning").removeClass("system-warning"),$(".play-url").removeClass("disabled"),$(".play-url").removeAttr("disabled"),$(".play-url").html("<span class='glyphicon glyphicon-circle-arrow-right resize-lg'></span> "+language_tokens.submit_link);else{var o=new RegExp(/\?v=([a-z0-9\-\_]+)\&?/i),n=o.exec(e);if(null==n||11!=n[1].length){var a=new RegExp(/\.be\/([a-z0-9\-\_]+)\&?/i),n=a.exec(e);null!=n&&11!=n[1].length?($(".url-box").blur(),$(".submit-warning").html("<span class='glyphicon glyphicon-ok'></span>"+language_tokens.submit_video_link),$(".submit-warning").addClass("system-success"),$(".submit-warning").removeClass("system-warning"),$(".play-url").removeClass("disabled"),$(".play-url").removeAttr("disabled"),$(".play-url").html("<span class='glyphicon glyphicon-circle-arrow-right resize-lg'></span> "+language_tokens.submit_link)):($(".submit-warning").html("<span class='glyphicon glyphicon-alert'></span> "+language_tokens.submit_no_link),$(".submit-warning").removeClass("system-success"),$(".submit-warning").addClass("system-warning"))}else $(".url-box").blur(),$(".submit-warning").html("<span class='glyphicon glyphicon-ok'></span>"+language_tokens.submit_video_link),$(".submit-warning").addClass("system-success"),$(".submit-warning").removeClass("system-warning"),$(".play-url").removeClass("disabled"),$(".play-url").removeAttr("disabled"),$(".play-url").html("<span class='glyphicon glyphicon-circle-arrow-right resize-lg'></span> "+language_tokens.submit_link)}},2e3)}else $(".submit-warning").empty()}).on("click",".btn-skip",function(){var e=getBoxToken();getNext(!0,e)}).on("click",".shuffle-playlist",function(){var e=getBoxToken();shufflePlaylist(e)}).on("click",".toggle-box-state",function(){var e=$(this),s=document.getElementById(e.attr("id")).dataset.field,t=document.getElementById(e.attr("id")).dataset.value,o={};o[s]=t;var n=getBoxToken(),a={packet_type:"box",token:n};switch(a[s]=t,updateEntry("rooms",$.param(o),n),conn.publish(n,a),s){case"room_submission_rights":1==t?sendMessage(n,4,1,"{submission_all}"):sendMessage(n,4,1,"{submission_mod}");break;case"room_protection":1==t?sendMessage(n,4,1,"{protect_public}"):sendMessage(n,4,1,"{protect_private}");break;case"room_play_type":1==t?sendMessage(n,4,1,"{auto-on}"):sendMessage(n,4,1,"{auto-off}")}}).on("click",".swap-order",function(){var e=document.getElementById($(this).attr("id")),s=/(\w*)-(\d*)/.exec(e.id),t=s[1],o=s[2],n=getBoxToken(),a=e.dataset.order;console.log(o,a,t,n),$.post("functions/swap_playlist_order.php",{history_id:o,current_order:a,action:t,box_token:n}).done(function(){loadPlaylist(n,!0)})}).on("click",".transfer-box",function(){var e=getBoxToken(),s=$(this).data("user");transferBox(e,s)}),$(window).on("beforeunload",function(){console.log(window.user_token);var e=getBoxToken();$.post("functions/leave_box.php",{box_token:e,user_token:window.user_token});var s={packet_type:"user",token:e,user:window.user_name,user_power:window.user_power,departure:!0};conn.publish(e,s),conn.close()});