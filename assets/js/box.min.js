function onYouTubeIframeAPIReady(){player=new YT.Player("player",{height:"85%",width:"60%",videoId:"",events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}}),resizeElements()}function addEntry(e,t,o){$.post("functions/post_history.php",{url:t,box_token:e,source:o}).done(function(e){return"playlist"!=o&&e&&requestCompletion(e),$("#body-chat").scrollTop($("#body-chat")[0].scrollHeight),e})}function fetchUserCard(e,t){$.when($.get("functions/fetch_user_card.php",{user_pseudo:e})).done(function(e){renderUserCard(e,t)})}function getActiveWatchers(e){$.get("functions/get_user_list.php",{box_token:e}).done(function(e){var t=JSON.parse(e);$(".rank-container").empty();for(var o=0;o<t.length;o++){var s="";s+="<div class='row' id='row-"+t[o].pseudo+"'>",s+="<p class='col-xs-10'>",s+=t[o].pseudo,s+="</p>",t[o].pseudo!=user_name&&2==user_power&&(s+="<p class='col-xs-1' title='"+language_tokens.transfer_box+"'><span class='glyphicon glyphicon-transfer button-glyph transfer-box' data-user='"+t[o].pseudo+"'></span></p>"),s+="</div>",$("#rank-"+t[o].power+"-container").append(s)}$("#watch-count").text(" "+t.length)})}function getBoxDetails(e){return $.get("functions/get_box_details.php",{box_token:e})}function getBoxToken(){return/([a-z0-9]+$)/i.exec(document.location.href)[0]}function getNext(e,t){2==window.user_power?(console.log("Fetching next video..."),$.post("functions/get_next.php",{box_token:t,user_power:window.user_power,lastPlayed:sessionStorage.getItem("currently-playing")}).done(function(e){e||setTimeout(getNext,5e3,!1,t)})):$(".sync-message").append("<span class='glyphicon glyphicon-refresh' title='"+language_tokens.synchronizing+"'></span> <span class='hidden-xs hidden-sm hidden-md'>"+language_tokens.synchronizing+"</span>")}function joinBox(e,t){return $.post("functions/join_box.php",{box_token:e,user_token:t})}function loadPlaylist(e,t){t&&clearTimeout(refresh_playlist_timer),"none"!=$("#song-list").css("display")&&($("#playlist-filter").is(":focus")||$.post("functions/get_history.php",{box_token:e}).done(function(e){var t=JSON.parse(e),o=0,s=0;$("#body-song-list").empty();for(var n=-1,a=0;a<t.length;a++){var i="",l=t[a].videoName.replace(/'/g,"&#39");if(n!=t[a].videoStatus)switch(t[a].videoStatus){case"0":case"3":if(0==a){var r="<p class='list-rank' id='list-upcoming'>"+language_tokens.sl_upcoming+"</p>";$("#body-song-list").append(r)}break;case"1":i+="<p class='list-rank'>"+language_tokens.now_playing+"</p>";break;case"2":i+="<p class='list-rank' id='list-played'>"+language_tokens.sl_played+"</p>"}var c;if(2==t[a].videoStatus)i+="<div class='row playlist-entry song-played'>",c=10,s++;else if(1==t[a].videoStatus)i+="<div class='row playlist-entry song-playing'>",c=11;else if(3==t[a].videoStatus)i+="<div class='row playlist-entry song-ignored'>",c=10;else{var i="<div class='row playlist-entry song-upcoming'>";o++,c=10}2!=window.user_power&&3!=window.user_power&&c++,i+="<div>",(2==window.user_power||3==window.user_power)&&("0"==t[a].videoStatus||"3"==t[a].videoStatus)&&(c-=2,i+="<div class='col-xs-1'>",0!=a&&(i+="<span class='glyphicon glyphicon-arrow-up button-glyph swap-order' id='up-"+t[a].entry+"' data-order='"+t[a].order+"' title='"+language_tokens.song_up+"'></span>"),i+="</div>",i+="<div class='col-xs-1'>",(0==t[a+1].videoStatus||3==t[a+1].videoStatus)&&(i+="<span class='glyphicon glyphicon-arrow-down button-glyph swap-order' id='down-"+t[a].entry+"' data-order='"+t[a].order+"' title='"+language_tokens.song_down+"'></span>"),i+="</div>"),i+="<div class='col-xs-"+c+"'>",i+="<p class='song-list-line'><a href='https://www.youtube.com/watch?v="+t[a].videoLink+"' target='_blank' title='"+l+"'>"+t[a].videoName+"</a></p></div>",(2==window.user_power||3==window.user_power)&&(i+="<div class='col-xs-1'>",1==t[a].pending&&(i+="<span class='glyphicon glyphicon-pencil button-glyph' onClick=requestCompletion("+t[a].index+")></span>"),i+="</div>",i+="<div class='col-xs-1'>",0==t[a].videoStatus?i+="<span class='glyphicon glyphicon-ban-circle button-glyph ignore-video' id='ignore-"+t[a].entry+"' data-target='"+t[a].entry+"'></span>":3==t[a].videoStatus&&(i+="<span class='glyphicon glyphicon-ok-circle button-glyph reinstate-video' id='reinstate-"+t[a].entry+"' data-target='"+t[a].entry+"'></span>")),2==t[a].videoStatus&&-1!=user_token&&(2==window.room_submission_rights&&1!=user_power||1==window.room_submission_rights)&&(i+="<span class='glyphicon glyphicon-repeat button-glyph quick-requeue' id='quick-requeue-"+t[a].entry+"' data-target='"+t[a].entry+"'></span>"),i+="</div>",i+="</div>",i+="<div class='col-xs-12 video-sub-details'>",i+="<span class='tip'><span class='glyphicon glyphicon-user'></span> "+t[a].submitter+"  <span class='glyphicon glyphicon-time'></span> "+moment(moment.utc(t[a].submitTime)).local().fromNow()+"</span>",i+="</div>",i+="</div>",n=t[a].videoStatus,$("#body-song-list").append(i)}$("#list-upcoming").append(" ("+o+")"),$("#list-played").append(" ("+s+")")}),-1!=user_token&&($("#likes-filter").is(":focus")||$.get("functions/get_likes.php",{user_token:user_token}).done(function(e){var t=JSON.parse(e);$("#body-song-likes").empty();for(var o=0;o<t.length;o++){var s="",n=t[o].video_name.replace(/'/g,"&#39");s+="<div class='row likes-entry'>",s+="<div class='col-xs-11'>",s+="<p class='fav-list-line'>",s+="<span class='glyphicon glyphicon-"+t[o].key_icon+" emotion-"+t[o].key_mood+"'></span> ",s+="<a href='"+t[o].video_link+"' target='_blank' title='"+n+"'>"+t[o].video_name+"</a></p></div>",1==window.room_state&&(s+="<span class='glyphicon glyphicon-circle-arrow-right button-glyph quick-submit' id='quick-submit-"+t[o].video_id+"' data-target='"+t[o].video_id+"'></span>"),s+="</div>",$("#body-song-likes").append(s)}})),refresh_playlist_timer=setTimeout(loadPlaylist,8e3,e,!1))}function onPlayerReady(){var e=getBoxToken();sessionStorage.setItem("currently-playing",""),synchronize(e)}function onPlayerStateChange(e){var t=getBoxToken();0!=window.autoplay&&e.data==YT.PlayerState.ENDED&&getNext(!1,t),e.data==YT.PlayerState.PLAYING&&-1!=user_token&&fetchMood(user_token,sessionStorage.getItem("currently-playing")),window.playerStatus=e.data}function playSong(e,t,o,s,n){var a=getBoxToken();if(0!=s){var i=moment.utc(s).add(7,"s"),l=moment(i).local(),r=Math.round(moment().diff(l)/1e3);0>r&&(r=0),player.loadVideoById(t,r)}else player.loadVideoById(t,0);if($(".sync-message").empty(),sessionStorage.setItem("currently-playing",e),document.title=o+" | Berrybox",$(".currently-name").empty(),$(".currently-name").html(o),$("#video-submitter").html(n),user_token==box_details.room_creator&&(0==s||3>=r)){var c={packet_type:"notification",token:a,notification_type:"info",content:language_tokens.now_playing+o};conn.publish(a,c),$.post("functions/register_song.php",{index:e})}displayMoodVotes(e)}function refreshWatchers(e){var t=parseInt($("#watch-count").text());if(e.arrival&&(t++,$("#watch-count").text(" "+t),e.user)){var o="<div class='row' id='row-"+e.user+"'>";o+="<p class='col-xs-10'>",o+=e.user,o+="</p>",2==window.user_power&&(o+="<p class='col-xs-1' title='"+language_tokens.transfer_box+"'><span class='glyphicon glyphicon-transfer button-glyph transfer-box' data-user='"+e.user+"'></span></p>"),o+="</div>",$("#rank-"+e.user_power+"-container").append(o)}e.departure&&(t--,$("#watch-count").text(" "+t),e.user&&$("#row-"+e.user).remove())}function renderBoxState(e){getBoxToken();if(e.room_name&&$("#room-title").text(e.room_name),e.stat_visitors&&($(".creator-views").text(e.stat_visitors),$(".creator-followers").text(e.stat_followers)),e.user_pseudo&&e.user_pseudo!=$("#box-creator-link").text()){if(e.user_pseudo==window.user_name){if($(".btn-toggle-follow").remove(),$(".playlist-actions").is(":empty")){console.log("loading skip buttons");var t="<button class='btn btn-default btn-admin btn-skip col-xs-6'><span class='glyphicon glyphicon-step-forward resize-lg'></span> <span class='hidden-xs hidden-sm hidden-md'> "+language_tokens.skip+"</span></button>";t+="<button class='btn btn-default btn-admin shuffle-playlist col-xs-6'><span class='glyphicon glyphicon-random resize-lg'></span> <span class='hidden-xs hidden-sm hidden-md'> "+language_tokens.shuffle+"</span></button>",$(".playlist-actions").append(t)}var t="<div class='admin-options'>";t+="<div role='separator' class='divider options-divider'></div>",t+="<p class='options-title'>"+language_tokens.creator_options+"</p>",t+="<div class='room-option'>",t+="<p class='option-title'>"+language_tokens.play_type+"</p>",t+="<span class='tip'>"+language_tokens.play_type_tip+"</span>",t+="<div class='row'>",t+="<div class='col-lg-6'>",t+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-automatic' data-field='room_play_type' data-value='1' data-twin='select-manual'>",t+="<span class='glyphicon glyphicon-play-circle'></span> ",t+=language_tokens.auto_play,t+="</span>",t+="</div>",t+="<div class='col-lg-6'>",t+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-manual' data-field='room_play_type' data-value='2' data-twin='select-automatic'>",t+="<span class='glyphicon glyphicon-hourglass'></span> ",t+=language_tokens.manual_play,t+="</span>",t+="</div>",t+="</div>",t+="</div>",t+="<div class='room-option'>",t+="<p class='option-title'>"+language_tokens.submit_type+"</p>",t+="<span class='tip'>"+language_tokens.submit_type_tip+"</span>",t+="<div class='row'>",t+="<div class='col-lg-6'>",t+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-everyone' data-field='room_submission_rights' data-value='1' data-twin='select-mods-only'>",t+="<span class='glyphicon glyphicon-ok-sign'></span> ",t+=language_tokens.submit_all,t+="</span>",t+="</div>",t+="<div class='col-lg-6'>",t+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-mods-only' data-field='room_submission_rights' data-value='2' data-twin='select-everyone'>",t+="<span class='glyphicon glyphicon-ok-circle'></span> ",t+=language_tokens.submit_mod,t+="</span>",t+="</div>",t+="</div>",t+="</div>",t+="<div class='room-option'>",t+="<p class='option-title'>"+language_tokens.room_protection+"</p>",t+="<span class='tip'>"+language_tokens.protection_tip+"</span>",t+="<div class='row'>",t+="<div class='col-lg-6'>",t+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-public' data-field='room_protection' data-value='1' data-twin='select-private'>",t+="<span class='glyphicon glyphicon-volume-up'></span> ",t+=language_tokens.level_public,t+="</span>",t+="</div>",t+="<div class='col-lg-6'>",t+="<span class='btn btn-primary btn-block btn-switch toggle-box-state' id='select-private' data-field='room_protection' data-value='2' data-twin='select-public'>",t+="<span class='glyphicon glyphicon-headphones'></span> ",t+=language_tokens.level_private,t+="</span>",t+="</div>",t+="</div>",t+="</div>",t+="<div class='room-option'>",t+="<p class='option-title'>"+language_tokens.room_params+"</p>",t+="<span class='tip'>"+language_tokens.room_params_tip+"</span>",t+="<form class='form-horizontal' id='form-box-details'>",t+="<div class='form-group'>",t+="<label for='room_name' class='col-lg-4 control-label'>"+language_tokens.room_name+"</label>",t+="<div class='col-lg-8'><input type='text' name='room_name' class='form-control' id='box-name-input' value='"+e.room_name+"'></div>",t+="</div>",t+="<div class='form-group'>",t+="<label for='room_lang' class='col-lg-4 control-label'>"+language_tokens.speak_lang+"</label>",t+="<div class='col-lg-8'>",t+="<select name='room_lang' id='' class='form-control'>",t+="<option value='en'>"+language_tokens.lang_en+"</option>",t+="<option value='fr'>"+language_tokens.lang_fr+"</option>",t+="<option value='jp'>"+language_tokens.lang_jp+"</option>",t+="</select>",t+="</div>",t+="</div>",t+="<div class='form-group'>",t+="<label form='room_type' class='col-lg-4 control-label'>"+language_tokens.room_type+"</label>",t+="<div class='col-lg-8'>",t+="<select name='room_type' class='form-control' id='type-select'>",$.get("functions/fetch_box_types.php",{box_token:getBoxToken()}).done(function(e){for(var t=JSON.parse(e),o=0;o<t.length;o++)$("#type-select").append($("<option></option>").text(language_tokens[t[o].type]).val(t[o].id))}),t+="</select>",t+="</div>",t+="</div>",t+="<div class='form-group'>",t+="<label form='room_description' class='col-lg-4 control-label'>"+language_tokens.description_limit+"</label>",t+="<div class='col-lg-8'>",t+="<textarea name='room_description' cols='30' rows='5' class='form-control'>"+e.room_description+"</textarea>",t+="</div>",t+="</div>",t+="</form>",t+="<button class='btn btn-primary btn-block' id='save-room-button'>"+language_tokens.save_changes+"</button>",t+="</div>",$(".admin-options").empty(),$("#body-options-list").append(t)}else{$(".admin-options").empty(),$(".playlist-actions").empty();var o="",s="",n="";1==e.following_creator?(o="btn-unfollow btn-active",s="unfollow",n=language_tokens.following+" "+e.user_pseudo):(o="btn-follow",s="follow",n=language_tokens.follow+" "+e.user_pseudo);var a="<button class='btn btn-primary btn-toggle-follow "+o+"' id='box-title-"+s+"' value='"+e.user_pseudo+"'>";if(a+="<span class='glyphicon glyphicon-heart'></span>",a+="<span class='hidden-xs hidden-sm'> ",a+=n,a+="</span>",a+="</button>",0==$(".btn-toggle-follow").length&&$(".creator-stats").prepend(a),0==$(".user-options").length){var t="<div class='user-options'>";t+="<span class='option-title'>"+language_tokens.sync+"</span><br>",t+="<span class='tip'>"+language_tokens.sync_tip+"</span>",t+="<button class='btn btn-default btn-admin btn-block sync-on' id='btn-synchro'><span class='glyphicon glyphicon-refresh'></span> "+language_tokens.sync_on+"</button>",t+="</div>",$("#body-options-list").empty(),$("#body-options-list").append(t)}}$("#box-creator-link").attr("href","user/"+e.user_pseudo),$("#box-creator-link").text(e.user_pseudo),$("#box-creator-picture").attr("src","profile-pictures/"+e.user_pp),$("#box-creator-picture").attr("title",e.user_pseudo+" ("+language_tokens.room_admin+")")}e.room_submission_rights&&(console.log("rendering submission rights"),1==e.room_submission_rights?(window.submission=!0,$(".room-quick-messages").removeClass("col-sm-offset-4"),$(".submission-message").empty(),$("#select-everyone").trigger("activate"),$(".add-link").show()):(1==window.user_power&&($(".add-link").hide(),$(".room-quick-messages").addClass("col-sm-offset-4")),window.submission=!1,$(".submission-message").html("<span class='glyphicon glyphicon-play-circle' title='"+language_tokens.submit_mod+"'></span> <span class='hidden-xs hidden-sm hidden-md'>"+language_tokens.submit_mod+"</span></div>"),$("#select-mods-only").trigger("activate")),window.room_submission_rights=e.room_submission_rights),e.room_protection&&(console.log("rendering protection"),2==e.room_protection?(window.protection=2,$(".protection-message").html("<span class='glyphicon glyphicon-headphones' title='"+language_tokens.level_private+"'></span> <span class='hidden-xs hidden-sm hidden-md'>"+language_tokens.level_private+"</span></div>"),$("#select-private").trigger("activate")):(window.protection=1,$(".protection-message").empty(),$("#select-public").trigger("activate")),window.protection=e.protection),e.room_play_type&&(console.log("rendering play type"),1==e.room_play_type?(window.autoplay=!0,$(".play-message").empty(),$("#select-automatic").trigger("activate")):(window.autoplay=!1,$(".play-message").html("<span class='glyphicon glyphicon-hourglass' title='"+language_tokens.manual_play+"'></span> <span class='hidden-xs hidden-sm hidden-md'>"+language_tokens.manual_play+"</span></div>"),$("#select-manual").trigger("activate")))}function renderUserCard(e,t){$(".user-card").remove();var o=JSON.parse(e),s="<div class='user-card'>";s+="<div class='user-card-section container-fluid'>",s+="<div class='col-xs-3'>",s+="<img src='"+o.user_pp+"' class='img-responsive'>",s+="</div>",s+="<div class='col-xs-9 container-fluid'>",s+="<p class='row text-focus' id='user-card-name'><a href='user/"+o.user_pseudo+"' target='_blank'>"+o.user_pseudo+"</a><span class='glyphicon glyphicon-remove button-glyph' id='user-card-close'></span></p>",s+="<div class='row user-card-stats'>",s+="<div class='col-xs-3'><span class='glyphicon glyphicon-heart' title='"+language_tokens.total_followers+"'></span> "+o.followers+"</div>",s+="<div class='col-xs-3'><span class='glyphicon glyphicon-eye-open' title='"+language_tokens.total_views+"'></span> "+o.visitors+"</div>",s+="<div class='col-xs-3'><span class='glyphicon glyphicon-plus' title='"+language_tokens.rooms_created+"'></span> "+o.rooms+"</div>",s+="<div class='col-xs-3'><span class='glyphicon glyphicon-music' title='"+language_tokens.songs_submitted+"'></span> "+o.songs+"</div>",s+="</div>",s+="</div>",s+="</div>",o.badge&&(s+="<div class='user-card-section user-card-badge container-fluid'>",s+="<div class='col-xs-2'>",s+="<img src='"+o.badge+"' class='img-responsive'>",s+="</div>",s+="<div class='col-xs-10 container-fluid'>",s+="<p class='row text-focus' id='user-badge-name'>"+o.badge_name+"</p>",s+="<span class='row badge-unlocked'>"+moment(moment.utc(o.unlock_date)).local().format("lll")+"</span>",s+="</div>",s+="</div>"),o.user_pseudo!=window.user_name&&(s+="<div class='user-card-actions'>",s+="<button class='btn btn-primary whisper-action'>"+language_tokens.whisper+"</button>",s+=1==o.following?"<button class='btn btn-primary btn-active btn-card btn-unfollow' id='user-card-unfollow' value='"+o.user_pseudo+"'><span class='glyphicon glyphicon-heart'></span></button>":"<button class='btn btn-primary btn-card btn-follow' id='user-card-follow' value='"+o.user_pseudo+"'><span class='glyphicon glyphicon-heart'></span></button>",2==user_power&&(s+="<button class='btn btn-primary transfer-box' data-user='"+o.user_pseudo+"' title='"+language_tokens.transfer_box+"'><span class='glyphicon glyphicon-transfer'></span> Give creatorsihp</button>"),s+="</div>"),s+="</div>",t.after(s),$("#body-chat").scrollTop($("#body-chat")[0].scrollHeight)}function requeueSong(e,t){$.post("functions/requeue_song.php",{box_token:e,video_id:t,user_token:user_token}).done(function(){$("#body-chat").scrollTop($("#body-chat")[0].scrollHeight),loadPlaylist(e,!0)})}function shufflePlaylist(e){$.get("functions/playlist_shuffle.php",{box_token:e}).done(function(){loadPlaylist(e,!0)})}function submitLink(){$(".submit-warning").empty();var e=getBoxToken(),t=$(".url-box").val();if(""!=t){var o=new RegExp(/list=([a-z0-9\-\_]+)\&?/i),s=o.exec(t);if(null!=s){pID=s[1],$(".under-video").append("<div class='modal-body' id='sec-player' style='display:none;'></div>");var n;n=new YT.Player("sec-player",{height:"5",width:"5",videoId:"",events:{onReady:onSecPlayerReady,onStateChange:onSecPlayerStateChange}})}else{var a=new RegExp(/\?v=([a-z0-9\-\_]+)\&?/i),i=a.exec(t);if(null==i){var l=new RegExp(/\.be\/([a-z0-9\-\_]+)\&?/i);i=l.exec(t)}var r=i[1];addEntry(e,r,"solo"),$(".url-box").val("")}}}function synchronize(e){$.post("functions/load_current.php",{box_token:e,user_power:window.user_power}).done(function(t){if(t){var o=JSON.parse(t);playSong(o.index,o.link,o.title,o.timestart,o.submitter)}else console.log("There's no video playing."),getNext(!1,e)})}function toggleVideoInQueue(e,t,o){$.post("functions/toggle_video_in_queue.php",{box_token:e,video_id:t,play_flag:o}).done(function(t){var s={packet_type:"notification",token:e,notification_type:"info",content:""};0==o&&(s.content=language_tokens.song_reinstated+t),3==o&&(s.content=language_tokens.song_ignored+t),conn.publish(e,s),loadPlaylist(e,!0)})}function transferBox(e,t){$.post("functions/transfer_box.php",{box_token:e,user_target:t}).done(function(){var o={packet_type:"notification",token:e,notification_type:"info",content:t+" "+language_tokens.box_transfered};conn.publish(e,o);var s={packet_type:"refresh",token:e};conn.publish(e,s)})}function refreshUserState(e,t){$.get("functions/get_user_state.php",{box_token:e,user_token:t}).done(function(t){var o=JSON.parse(t);2==o.room_user_state||3==o.room_user_state?1!=window.playerStatus&&synchronize(e):$(".playlist-actions").empty(),window.user_power=o.room_user_state,console.log("Your power has changed to : "+window.user_power)})}function watchBoxState(e){$.get("functions/get_box_status.php",{box_token:e}).done(function(e){var t=JSON.parse(e);0!=window.room_state&&0==t.room_active&&$("#body-chat").append("<p class='system-message'><span class='glyphicon glyphicon-info-sign'></span> "+language_tokens.room_closing+"</p>")})}var tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);var player,refresh_playlist_timer;$(document).ready(function(){var e=getBoxToken();$.when(joinBox(e,user_token),getUserLang(),getBoxDetails(e)).done(function(t,o,s){window.user_power=t[0],window.language_tokens=JSON.parse(o[0]),window.lang=language_tokens.user_lang,window.box_details=JSON.parse(s[0]),window.room_state=box_details.room_active,getActiveWatchers(e),renderBoxState(box_details),window.conn=new ab.Session("ws://46.101.79.44:8080",function(){$("#body-chat").append(2==user_power?"<p class='system-message'>"+language_tokens.welcome_admin+"</p>":"<p class='system-message'>"+language_tokens.welcome+"</p>");var t={packet_type:"user",token:e,user:window.user_name,user_power:window.user_power,arrival:!0};conn.publish(e,t),conn.subscribe(e,function(t,o){switch(o.packet_type){case"chat":console.log("recieved chat message"),displayMessage(o);break;case"sync":console.log("recieved sync packet."),playSong(o.index,o.link,o.title,o.timestart,o.submitter);break;case"box":console.log("recieved box packet."),renderBoxState(o);break;case"user":console.log("recieved user packet."),refreshWatchers(o);break;case"refresh":console.log("recieved refresh packet"),$.when(getBoxDetails(e)).done(function(t){window.box_details=JSON.parse(t),renderBoxState(box_details),getActiveWatchers(e),refreshUserState(e,window.user_token)});break;case"notification":$("#body-chat").notify(o.content,{arrowShow:!1,autoHideDelay:3e3,className:o.notification_type,gap:2,position:"left-top",style:"berrybox"})}}),conn.subscribe(user_token,function(e,t){switch(console.log(e,t),t.packet_type){case"badge":unlockBadge(t);break;case"notification":$("#body-chat").notify(t.content,{arrowShow:!1,autoHideDelay:3e3,className:t.notification_type,gap:2,position:"left-top",style:"berrybox"})}})},function(){console.warn("WebSocket connection closed")},{skipSubprotocolCheck:!0}),user_token!=box_details.room_creator?$.post("functions/check_creator.php",{box_token:e}).done(function(e){0==e&&$("#body-chat").append("<p class='system-message system-alert'>"+language_tokens.no_admin+"</p>")}):window.autoplay=1==box_details.room_play_type?!0:!1,setInterval(function(){$.post("functions/refresh_session.php")},18e5),fetchEmotes().done(function(e){var t=JSON.parse(e);window.emotes=[];for(var o=0;o<t.length;o++)emotes.push(t[o].emoteText)}),window.chatHovered=!1,window.showingMoods,window.hidingMoods}),$("#playlist-filter").on("keyup",function(){var e=$(".playlist-entry"),t=$.trim($(this).val()).replace(/ +/g," ").toLowerCase();e.show().filter(function(){var e=$(this).text().replace(/\s+/g," ").toLowerCase();return!~e.indexOf(t)}).hide()}),$("#likes-filter").on("keyup",function(){var e=$(".likes-entry"),t=$.trim($(this).val()).replace(/ +/g," ").toLowerCase();e.show().filter(function(){var e=$(this).text().replace(/\s+/g," ").toLowerCase();return!~e.indexOf(t)}).hide()})}).on("mouseenter",".btn-unfollow",function(){var e=$(this).attr("id"),t=$(this).val();if($(this).hasClass("btn-card"))var o="<span class='glyphicon glyphicon-minus'></span> <span class='hidden-xs hidden-sm'></span>";else var o="<span class='glyphicon glyphicon-minus'></span> <span class='hidden-xs hidden-sm'>"+language_tokens.unfollow+" "+t+"</span>";$("#"+e).html(o),$("#"+e).removeClass("btn-active"),$("#"+e).addClass("btn-danger")}).on("mouseleave",".btn-unfollow",function(){var e=$(this).attr("id"),t=$(this).val();if($(this).hasClass("btn-card"))var o="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'></span>";else var o="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'>"+language_tokens.following+" "+t+"</span>";$("#"+e).html(o),$("#"+e).removeClass("btn-danger"),$("#"+e).addClass("btn-active")}).on("click",".btn-unfollow",function(){var e=$(this).attr("value"),t=$(this).attr("id");$.post("functions/unfollow_user.php",{userFollowing:user_token,userFollowed:e}).done(function(){if($("#"+t).removeClass("btn-active"),$("#"+t).hasClass("btn-card"))var o="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'></span>";else var o="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'>"+language_tokens.follow+" "+e+"</span>";$("#"+t).html(o),$("#"+t).removeClass("btn-danger"),$("#"+t).removeClass("btn-unfollow"),$("#"+t).addClass("btn-follow"),$("#"+t).attr("id",t.substr(0,t.length-6)+"follow"),e==box_details.creator_pseudo&&($("#box-title-unfollow").removeClass("btn-active"),$("#box-title-unfollow").html(o),$("#box-title-unfollow").removeClass("btn-danger"),$("#box-title-unfollow").removeClass("btn-unfollow"),$("#box-title-unfollow").addClass("btn-follow"),$("#box-title-unfollow").attr("id","box-title-follow"))})}).on("click",".btn-follow",function(){var e=$(this).attr("value"),t=$(this).attr("id");$.post("functions/follow_user.php",{userFollowing:user_token,userFollowed:e}).done(function(){if($("#"+t).addClass("btn-active"),$("#"+t).hasClass("btn-card"))var o="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'></span>";else var o="<span class='glyphicon glyphicon-heart'></span> <span class='hidden-xs hidden-sm'>"+language_tokens.following+" "+e+"</span>";$("#"+t).html(o),$("#"+t).removeClass("btn-follow"),$("#"+t).addClass("btn-unfollow"),$("#"+t).attr("id",t.substr(0,t.length-8)+"unfollow"),e==box_details.creator_pseudo&&($("#box-title-follow").addClass("btn-active"),$("#box-title-follow").html(o),$("#box-title-follow").removeClass("btn-follow"),$("#box-title-follow").addClass("btn-unfollow"),$("#box-title-follow").attr("id","box-title-unfollow"))})}).on("click",".play-url",function(){submitLink()}).on("focus",".url-box",function(){$(this).keypress(function(e){13==e.which&&($(this).hasClass("disabled")||submitLink())})}).on("click",".send-info",function(){fillInfo()}).on("click",".cancel-info",function(){var e=$(this).attr("id").substr(12);$("#warning-"+e).remove()}).on("focus",".info-box",function(){$(this).keypress(function(e){13==e.which&&fillInfo()})}).on("click",".color-cube",function(){var e=$(this),t=$(this).attr("id").substr(6,6);$.post("functions/change_color.php",{user_token:user_token,color:t}).done(function(){$(".close").click(),$(".color-cube").removeClass("cube-selected"),e.addClass("cube-selected")})}).on("click",".emotion-container",function(){if($(this).hasClass("selected"))var e=0;else var e=document.getElementById($(this).attr("id")).dataset.mood;voteMood(e,user_token,sessionStorage.getItem("currently-playing"))}).on("click",".ignore-video",function(){var e=document.getElementById($(this).attr("id")).dataset.target,t=getBoxToken();toggleVideoInQueue(t,e,3)}).on("click",".reinstate-video",function(){var e=document.getElementById($(this).attr("id")).dataset.target,t=getBoxToken();toggleVideoInQueue(t,e,0)}).on("click",".toggle-song-list, .toggle-menu-list, .toggle-user-list, .toggle-options-list",function(){var e,t=getBoxToken(),o=$(this).attr("class").split(" ")[4].substr(7),s="0px";if("none"==$("#"+o).css("display"))switch($("#"+o).toggle(),window.innerWidth>1024?e="25%":window.innerWidth<768?(e="0%",s=$("#heading-chat").offset().top+10):e="31.9%",o){case"song-list":loadPlaylist(t,!1),setTimeout(function(){$("#user-list").hide(),$("#menu-list").hide(),$("#options-list").hide()},200),$("#user-list").animate({right:"0px"},200),$("#menu-list").animate({right:"0px"},200),$("#options-list").animate({right:"0px"},200),jQuery(window).width()>992&&$("#currently-playing").animate({width:"68%"},200);break;case"user-list":setTimeout(function(){$("#song-list").hide(),$("#menu-list").hide(),$("#options-list").hide()},200),$("#song-list").animate({right:"0px"},200),$("#menu-list").animate({right:"0px"},200),$("#options-list").animate({right:"0px"},200),jQuery(window).width()>992&&$("#currently-playing").animate({width:"79%"},200);break;case"menu-list":setTimeout(function(){$("#song-list").hide(),$("#user-list").hide(),$("#options-list").hide()},200),$("#song-list").animate({right:"0px"},200),$("#user-list").animate({right:"0px"},200),$("#options-list").animate({right:"0px"},200),jQuery(window).width()>992&&$("#currently-playing").animate({width:"79%"},200);break;case"options-list":setTimeout(function(){$("#song-list").hide(),$("#user-list").hide(),$("#menu-list").hide()},200),$("#song-list").animate({right:"0px"},200),$("#user-list").animate({right:"0px"},200),$("#menu-list").animate({right:"0px"},200),jQuery(window).width()>992&&$("#currently-playing").animate({width:"68%"},200)}else $(this).t=setTimeout(function(){$("#"+o).hide()},200),e="0px",window.innerWidth<768&&(s=window.innerHeight+1),jQuery(window).width()>992&&$("#currently-playing").animate({width:"100%",top:s},200);$("#"+o).animate({right:e,top:s},200)}).on("mouseenter","#body-chat",function(){window.chatHovered=!0}).on("mouseleave","#body-chat",function(){window.chatHovered=!1}).on("click",".quick-submit",function(){var e=getBoxToken(),t=document.getElementById($(this).attr("id")).dataset.target;addEntry(e,t,"solo")}).on("click",".quick-requeue",function(){var e=getBoxToken(),t=document.getElementById($(this).attr("id")).dataset.target;requeueSong(e,t)}).on("click","#save-room-button",function(){var e=getBoxToken();$.when(updateEntry("rooms",$("#form-box-details").serialize(),e)).done(function(t){console.log(t),$("#save-room-button").blur(),$("#save-room-button").text(language_tokens.save_changes_feedback),$("#save-room-button").switchClass("btn-primary","btn-success feedback",200,"easeOutBack");var o={packet_type:"box",token:e,room_name:$("#box-name-input").val()};conn.publish(e,o),setTimeout(function(){$("#save-room-button").switchClass("btn-success feedback","btn-primary",1e3,"easeInQuad"),$("#save-room-button").text(language_tokens.save_changes)},1500)})}).on("keyup",".url-box",function(){var e=$(".url-box").val();if(""!=e){$(".play-url").addClass("disabled"),$(".play-url").attr("disabled","disabled"),$(".play-url").text(language_tokens.searching);var t;t&&clearTimeout(t),t=setTimeout(function(){var t=new RegExp(/list=([a-z0-9\-\_]+)\&?/i),o=t.exec(e);if(null!=o)$(".url-box").blur(),$(".submit-warning").html("<span class='glyphicon glyphicon-ok'></span>"+language_tokens.submit_playlist_link),$(".submit-warning").addClass("system-success"),$(".submit-warning").removeClass("system-warning"),$(".play-url").removeClass("disabled"),$(".play-url").removeAttr("disabled"),$(".play-url").html("<span class='glyphicon glyphicon-circle-arrow-right resize-lg'></span> "+language_tokens.submit_link);else{var s=new RegExp(/\?v=([a-z0-9\-\_]+)\&?/i),n=s.exec(e);if(null==n||11!=n[1].length){var a=new RegExp(/\.be\/([a-z0-9\-\_]+)\&?/i),n=a.exec(e);null!=n&&11!=n[1].length?($(".url-box").blur(),$(".submit-warning").html("<span class='glyphicon glyphicon-ok'></span>"+language_tokens.submit_video_link),$(".submit-warning").addClass("system-success"),$(".submit-warning").removeClass("system-warning"),$(".play-url").removeClass("disabled"),$(".play-url").removeAttr("disabled"),$(".play-url").html("<span class='glyphicon glyphicon-circle-arrow-right resize-lg'></span> "+language_tokens.submit_link)):($(".submit-warning").html("<span class='glyphicon glyphicon-alert'></span> "+language_tokens.submit_no_link),$(".submit-warning").removeClass("system-success"),$(".submit-warning").addClass("system-warning"))
}else $(".url-box").blur(),$(".submit-warning").html("<span class='glyphicon glyphicon-ok'></span>"+language_tokens.submit_video_link),$(".submit-warning").addClass("system-success"),$(".submit-warning").removeClass("system-warning"),$(".play-url").removeClass("disabled"),$(".play-url").removeAttr("disabled"),$(".play-url").html("<span class='glyphicon glyphicon-circle-arrow-right resize-lg'></span> "+language_tokens.submit_link)}},2e3)}else $(".submit-warning").empty()}).on("click",".btn-skip",function(){var e=getBoxToken();getNext(!0,e)}).on("click",".shuffle-playlist",function(){var e=getBoxToken();shufflePlaylist(e)}).on("click",".toggle-box-state",function(){var e=$(this),t=document.getElementById(e.attr("id")).dataset.field,o=document.getElementById(e.attr("id")).dataset.value,s={};s[t]=o;var n=getBoxToken(),a={packet_type:"box",token:n};a[t]=o,updateEntry("rooms",$.param(s),n),conn.publish(n,a);var i={packet_type:"notification",token:n,notification_type:"info",content:""};switch(t){case"room_submission_rights":i.content=1==o?language_tokens.submission_all:language_tokens.submission_mod;break;case"room_protection":i.content=1==o?language_tokens.protect_public:language_tokens.protect_private;break;case"room_play_type":i.content=1==o?language_tokens.auto_on:language_tokens.auto_off}conn.publish(n,i)}).on("click",".swap-order",function(){var e=document.getElementById($(this).attr("id")),t=/(\w*)-(\d*)/.exec(e.id),o=t[1],s=t[2],n=getBoxToken(),a=e.dataset.order;console.log(s,a,o,n),$.post("functions/swap_playlist_order.php",{history_id:s,current_order:a,action:o,box_token:n}).done(function(){loadPlaylist(n,!0)})}).on("click",".transfer-box",function(){var e=getBoxToken(),t=$(this).data("user");transferBox(e,t)}).on("click",".author-linkback",function(){var e=$(this).text(),t=$(this).parents("p");fetchUserCard(e,t)}),$(window).on("beforeunload",function(){console.log(window.user_token);var e=getBoxToken();$.post("functions/leave_box.php",{box_token:e,user_token:window.user_token});var t={packet_type:"user",token:e,user:window.user_name,user_power:window.user_power,departure:!0};conn.publish(e,t),conn.close()});