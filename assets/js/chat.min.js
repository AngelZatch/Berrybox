function getUserList(e){$.get("functions/get_user_list.php",{box_token:e}).done(function(e){var s=JSON.parse(e),t=[],n=0;for(n;n<s.length;n++)t.push(s[n].pseudo);$(".chatbox").textcomplete([{match:/(^|\b)(\w{2,})$/,search:function(e,s){s($.map(t,function(s){return 0===s.indexOf(e)?s:null}))},replace:function(e){return e}}])})}function fetchEmotes(){return $.post("functions/fetch_emotes.php")}function sendMessage(e,s,t,n,a){if("chatbox"==n&&1==s){var i=($(".chatbox").val(),$(".chatbox").val().substr(0,1));if("!"==i){var l=$(".chatbox").val().substr(1).split(" ");switch(l[0]){case"w":s=6,a=l[1],n="";for(var r=2;r<l.length;r++)n+=l[r],r!=l.length-1&&(n+=" ");$(".chatbox").val(""),$.post("functions/post_chat.php",{message:n,token:e,scope:s,destination:a,solveDestination:a});break;case"skip":case"next":2==window.user_power||3==window.user_power?$(".btn-skip").trigger("click"):$("#body-chat").append("<p class='system-message'><span class='glyphicon glyphicon-minus-sign'></span> "+language_tokens.no_power+"</p>");break;case"shuffle":case"random":2==window.user_power||3==window.user_power?$(".shuffle-playlist").trigger("click"):$("#body-chat").append("<p class='system-message'><span class='glyphicon glyphicon-minus-sign'></span> "+language_tokens.no_power+"</p>");break;default:$("#body-chat").append("<p class='system-message system-alert'>"+language_tokens.invalid_macro+"</p>")}$(".chatbox").val("")}else{var n=$(".chatbox").val();$(".chatbox").val(""),$.post("functions/post_chat.php",{message:n,token:e,scope:s,destination:a})}}else $.post("functions/post_chat.php",{message:n,token:e,scope:s,type:t,destination:a})}function loadChat(e,s,t,n){window.lastID||(window.lastID=0),$.get("functions/load_chat.php",{box_token:e,user_lang:n,last_message_id:window.lastID}).done(function(n){for(var a=JSON.parse(n),o=0;o<a.length;o++){var i=moment(moment.utc(a[o].timeStamp)).local().format("HH:mm");if(a[o].id!=window.lastID){window.lastID=a[o].id;for(var l=a[o].content.split(" "),r=0;r<t.length;r++)for(var c=0;c<l.length;c++)if(l[c]==t[r]){var p=l[c].replace(l[c],"<img src='assets/emotes/"+t[r]+".png' class='chat-emote' title='"+t[r]+"'>");l[c]=p}a[o].content=l.join(" ");var d=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,u=d.exec(a[o].content);if(null!=u){var g="<a href='"+u[0]+"' target='_blank'>"+u[0]+"</a>";a[o].content=a[o].content.replace(d,g)}var h="";switch(a[o].scope){case"6":if(a[o].destinationToken==s||a[o].authorToken==s)h+="<p class='whisper'>",h+="<span class='message-time'>"+i+"</span>",h+="<a style='text-decoration:none;'><span class='message-author author-linkback' style='color:#"+a[o].authorColor+";'>",h+=a[o].author,h+="</span></a>",h+="<span class='glyphicon glyphicon-chevron-right'></span> ",h+="<a style='text-decoration:none;'><span class='message-author author-linkback' style='color:#"+a[o].destinationColor+";'>",h+=a[o].destination,h+="</span></a> : ",h+=a[o].content,h+="</p>";else var h="";break;case"5":if(a[o].destinationToken==s)h+="<p class='system-message system-alert'>",h+="<span class='glyphicon glyphicon-exclamation-sign'></span> ",h+="<span class='message-content>"+a[o].content+"</span>",h+="</p>";else var h="";break;case"4":switch(h+="<p class='system-message",a[o].subType){case"1":h+="'><span class='glyphicon glyphicon-info-sign'></span> ";break;case"2":h+=" sm-type-play'><span class='glyphicon glyphicon-play'></span> ";break;case"3":h+=" sm-type-skip'><span class='glyphicon glyphicon-step-forward'></span> ",2!=user_power&&synchronize(e);break;case"4":h+=" sm-type-close'><span class='glyphicon glyphicon-remove-circle'></span> ";break;case"5":h+=" sm-type-ignore'><span class='glyphicon glyphicon-info-sign'></span> ";break;case"6":h+=" sm-type-reinstate'><span class='glyphicon glyphicon-info-sign'></span> ";break;case"7":h+=" sm-type-open'><span class='glyphicon glyphicon-play-circle'><span> "}h+=a[o].content,h+="</p>";break;case"3":if(2==user_power||3==user_power)h+="<p class='system-message'>",h+="<span class='glyphicon glyphicon-exclamation-sign'></span> ",h+=a[o].content,h+="</p>";else var h="";break;case"2":if(2==user_power){var h="<p class='system-message'>";h+="<span class='glyphicon glyphicon-exclamation-sign'></span> ",h+=a[o].content,h+="</p>"}else var h="";break;case"1":h+="<p class='standard-message'>",h+="<span class='message-time'>"+i+"</span> ",2==a[o].status?h+="<span class='chat-icon' title='"+language_tokens.room_admin+"'><img src='assets/berrybox-creator-logo.png'></span> ":3==a[o].status?2!=user_power&&3!=user_power||a[o].authorToken==s?h+="<span class='chat-icon' title='"+language_tokens.room_mod+"'><img src='assets/berrybox-moderator-logo.png'></span>":2==user_power&&(h+="<span class='chat-icon' title='"+language_tokens.room_mod+"'><img src='assets/berrybox-moderator-logo.png'></span> "):(2==user_power||3==user_power)&&2==user_power,1==a[o].authorPower&&(h+="<span class='chat-icon' title='"+language_tokens.staff+"'><img src='assets/berrybox-staff-logo.png'></span> "),h+="<a style='text-decoration:none'><span class='message-author author-linkback' style='color:#"+a[o].authorColor+";'>",h+=a[o].author,h+="</span></a>",h+=" : "+a[o].content+"<br/>",h+="</p>"}$("#body-chat").append(h)}else console.log("Double fetch. Denied");window.chatHovered||$("#body-chat").scrollTop($("#body-chat")[0].scrollHeight)}}),setTimeout(loadChat,1500,e,s,t,lang)}$(function(){}).on("focus",".chatbox",function(){var e=getBoxToken();getUserList(e),$(this).keypress(function(s){13===s.which&&sendMessage(e,1,null,"chatbox","")})}).on("click",".whisper-action",function(){var e=$("#user-card-name").text();$(".chatbox").val("!w "+e+" "),$(".chatbox").focus()}).on("click","#user-card-close",function(){$(".user-card").remove()});