function getUserList(s){$.get("functions/get_user_list.php",{box_token:s}).done(function(s){var e=JSON.parse(s),a=[],n=0;for(n;n<e.length;n++)a.push(e[n].pseudo);$(".chatbox").textcomplete([{match:/(^|\b)(\w{2,})$/,search:function(s,e){e($.map(a,function(e){return 0===e.indexOf(s)?e:null}))},replace:function(s){return s}}])})}function fetchEmotes(){return $.post("functions/fetch_emotes.php")}function sendMessage(s,e,a,n,o){if("chatbox"==n&&1==e){var t=($(".chatbox").val(),$(".chatbox").val().substr(0,1));if("!"==t){var c=$(".chatbox").val().substr(1).split(" ");switch(c[0]){case"w":e=6,o=c[1],n="";for(var p=2;p<c.length;p++)n+=c[p],p!=c.length-1&&(n+=" ");$(".chatbox").val(""),$.post("functions/post_chat.php",{message:n,token:s,scope:e,destination:o,solveDestination:o});break;case"skip":case"next":2==window.user_power||3==window.user_power?$(".btn-skip").trigger("click"):$("#body-chat").append("<p class='system-message'><span class='glyphicon glyphicon-minus-sign'></span> "+language_tokens.no_power+"</p>");break;case"shuffle":case"random":2==window.user_power||3==window.user_power?$(".shuffle-playlist").trigger("click"):$("#body-chat").append("<p class='system-message'><span class='glyphicon glyphicon-minus-sign'></span> "+language_tokens.no_power+"</p>");break;default:$("#body-chat").append("<p class='system-message system-alert'>"+language_tokens.invalid_macro+"</p>")}$(".chatbox").val("")}else{var n=$(".chatbox").val();$(".chatbox").val(""),$.post("functions/post_chat.php",{message:n,token:s,scope:e,destination:o})}}else $.post("functions/post_chat.php",{message:n,token:s,scope:e,type:a,destination:o})}function loadChat(s,e,a,n){window.lastID||(window.lastID=0),$.get("functions/load_chat.php",{box_token:s,user_lang:n,last_message_id:window.lastID}).done(function(n){for(var o=JSON.parse(n),t=0;t<o.length;t++){var c=moment(moment.utc(o[t].timeStamp)).local().format("HH:mm");if(o[t].id!=window.lastID){window.lastID=o[t].id;for(var p=o[t].content.split(" "),l=0;l<a.length;l++)for(var i=0;i<p.length;i++)if(p[i]==a[l]){var r=p[i].replace(p[i],"<img src='assets/emotes/"+a[l]+".png' class='chat-emote' title='"+a[l]+"'>");p[i]=r}o[t].content=p.join(" ");var g=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,h=g.exec(o[t].content);if(null!=h){var u="<a href='"+h[0]+"' target='_blank'>"+h[0]+"</a>";o[t].content=o[t].content.replace(g,u)}var m="";switch(o[t].scope){case"6":if(o[t].destinationToken==e||o[t].authorToken==e)m+="<p class='whisper'>",m+="<span class='message-time'>"+c+"</span>",m+="<a style='text-decoration:none;'><span class='message-author author-linkback' style='color:#"+o[t].authorColor+";'>",m+=o[t].author,m+="</span></a>",m+="<span class='glyphicon glyphicon-chevron-right'></span> ",m+="<a style='text-decoration:none;'><span class='message-author author-linkback' style='color:#"+o[t].destinationColor+";'>",m+=o[t].destination,m+="</span></a> : ",m+=o[t].content,m+="</p>";else var m="";break;case"5":if(o[t].destinationToken==e)m+="<p class='system-message system-alert'>",m+="<span class='glyphicon glyphicon-exclamation-sign'></span> ",m+="<span class='message-content>"+o[t].content+"</span>",m+="</p>";else var m="";break;case"4":switch(m+="<p class='system-message",o[t].subType){case"1":m+="'><span class='glyphicon glyphicon-info-sign'></span> ";break;case"2":m+=" sm-type-play'><span class='glyphicon glyphicon-play'></span> ";break;case"3":m+=" sm-type-skip'><span class='glyphicon glyphicon-step-forward'></span> ",2!=user_power&&synchronize(s);break;case"4":m+=" sm-type-close'><span class='glyphicon glyphicon-remove-circle'></span> ";break;case"5":m+=" sm-type-ignore'><span class='glyphicon glyphicon-info-sign'></span> ";break;case"6":m+=" sm-type-reinstate'><span class='glyphicon glyphicon-info-sign'></span> ";break;case"7":m+=" sm-type-open'><span class='glyphicon glyphicon-play-circle'><span> "}m+=o[t].content,m+="</p>";break;case"3":if(2==user_power||3==user_power)m+="<p class='system-message'>",m+="<span class='glyphicon glyphicon-exclamation-sign'></span> ",m+=o[t].content,m+="</p>";else var m="";break;case"2":if(2==user_power){var m="<p class='system-message'>";m+="<span class='glyphicon glyphicon-exclamation-sign'></span> ",m+=o[t].content,m+="</p>"}else var m="";break;case"1":m+="<p class='standard-message'>",m+="<span class='message-time'>"+c+"</span> ",2==o[t].status?m+="<span class='chat-icon' title='"+language_tokens.room_admin+"'><img src='assets/berrybox-creator-logo.png'></span> ":3==o[t].status&&(2!=user_power&&3!=user_power||o[t].authorToken==e?m+="<span class='chat-icon' title='"+language_tokens.room_mod+"'><img src='assets/berrybox-moderator-logo.png'></span>":2==user_power&&(m+="<span class='chat-icon' title='"+language_tokens.room_mod+"'><img src='assets/berrybox-moderator-logo.png'></span> ")),1==o[t].authorPower&&(m+="<span class='chat-icon' title='"+language_tokens.staff+"'><img src='assets/berrybox-staff-logo.png'></span> "),m+="<a style='text-decoration:none'><span class='message-author author-linkback' style='color:#"+o[t].authorColor+";'>",m+=o[t].author,m+="</span></a>",m+=" : "+o[t].content+"<br/>",m+="</p>"}$("#body-chat").append(m)}else console.log("Double fetch. Denied");window.chatHovered||$("#body-chat").scrollTop($("#body-chat")[0].scrollHeight)}}),setTimeout(loadChat,1500,s,e,a,lang)}$(function(){}).on("focus",".chatbox",function(){var s=getBoxToken();getUserList(s),$(this).keypress(function(e){13===e.which&&sendMessage(s,1,null,"chatbox","")})}).on("click",".whisper-action",function(){var s=$("#user-card-name").text();$(".chatbox").val("!w "+s+" "),$(".chatbox").focus()}).on("click","#user-card-close",function(){$(".user-card").remove()});