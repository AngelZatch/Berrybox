function getUserList(s){$.get("functions/get_user_list.php",{box_token:s}).done(function(s){var e=JSON.parse(s),a=[],n=0;for(n;n<e.length;n++)a.push(e[n].pseudo);$(".chatbox").textcomplete([{match:/(^|\b)(\w{2,})$/,search:function(s,e){e($.map(a,function(e){return 0===e.indexOf(s)?e:null}))},replace:function(s){return s}}])})}function fetchEmotes(){return $.post("functions/fetch_emotes.php")}function sendMessage(s,e,a,n,t){if("chatbox"==n&&1==e){var o=($(".chatbox").val(),$(".chatbox").val().substr(0,1));if("!"==o){var c=$(".chatbox").val().substr(1).split(" ");switch(c[0]){case"w":e=6,t=c[1],n="";for(var p=2;p<c.length;p++)n+=c[p],p!=c.length-1&&(n+=" ");$(".chatbox").val(""),$.post("functions/post_chat.php",{message:n,token:s,scope:e,destination:t,solveDestination:t});break;case"skip":case"next":2==window.user_power||3==window.user_power?$(".btn-skip").trigger("click"):$("#body-chat").append("<p class='system-message'><span class='glyphicon glyphicon-minus-sign'></span> "+language_tokens.no_power+"</p>");break;case"shuffle":case"random":2==window.user_power||3==window.user_power?$(".shuffle-playlist").trigger("click"):$("#body-chat").append("<p class='system-message'><span class='glyphicon glyphicon-minus-sign'></span> "+language_tokens.no_power+"</p>");break;default:$("#body-chat").append("<p class='system-message system-alert'>"+language_tokens.invalid_macro+"</p>")}$(".chatbox").val("")}else{var n=$(".chatbox").val();$(".chatbox").val(""),$.post("functions/post_chat.php",{message:n,token:s,scope:e,destination:t})}}else $.post("functions/post_chat.php",{message:n,token:s,scope:e,type:a,destination:t})}function displayMessage(s){for(var e="",a=moment(moment.utc(s.timeStamp)).local().format("HH:mm"),n=s.content.split(" "),t=0;t<emotes.length;t++)for(var o=0;o<n.length;o++)if(n[o]==emotes[t]){var c=n[o].replace(n[o],"<img src='assets/emotes/"+emotes[t]+".png' class='chat-emote' title='"+emotes[t]+"'>");n[o]=c}s.content=n.join(" ");var p=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,l=p.exec(s.content);if(null!=l){var i="<a href='"+l[0]+"' target='_blank'>"+l[0]+"</a>";s.content=s.content.replace(p,i)}switch(s.scope){case"1":e+="<p class='standard-message'>",e+="<span class='message-time'>"+a+"</span> ",2==s.authorStatus?e+="<span class='chat-icon' title='"+language_tokens.room_admin+"'><img src='assets/berrybox-creator-logo.png'></span> ":3==s.authorStatus&&(e+="<span class='chat-icon' title='"+language_tokens.room_mod+"'><img src='assets/berrybox-moderator-logo.png'></span> "),1==s.authorGlobalPower&&(e+="<span class='chat-icon' title='"+language_tokens.staff+"'><img src='assets/berrybox-staff-logo.png'></span> "),e+="<a style='text-decoration:none'><span class='message-author author-linkback' style='color:#"+s.authorColor+";'>",e+=s.author,e+="</span></a>",e+=" : "+s.content+"<br/>",e+="</p>";break;case"2":2==user_power&&(e="<p class='system-message'>",e+="<span class='glyphicon glyphicon-exclamation-sign'></span>",e+=s.content,e+="</p>");break;case"3":(2==user_power||3==user_power)&&(e="<p class='system-message'>",e+="<span class='glyphicon glyphicon-exclamation-sign'></span>",e+=s.content,e+="</p>");break;case"4":switch(e+="<p class='system-message",s.subType){case"1":e+="'><span class='glyphicon glyphicon-info-sign'></span> ";break;case"2":e+=" sm-type-play'><span class='glyphicon glyphicon-play'></span>";break;case"3":e+=" sm-type-skip'><span class='glyphicon glyphicon-step-forward'></span> ";break;case"4":e+=" sm-type-close'><span class='glyphicon glyphicon-remove-circle'></span> ";break;case"5":e+=" sm-type-ignore'><span class='glyphicon glyphicon-info-sign'></span> ";break;case"6":e+=" sm-type-reinstate'><span class='glyphicon glyphicon-info-sign'></span> ";break;case"7":e+=" sm-type-open'><span class='glyphicon glyphicon-play-circle'><span> "}e+=s.content,e+="</p>";break;case"5":s.destinationToken==user_token&&(e+="<p class='system-message system-alert'>",e+="<span class='glyphicon glyphicon-exclamation-sign'></span> ",e+="<span class='message-content'> "+s.content+"</span>",e+="</p>");break;case"6":(s.destinationToken==user_token||s.authorToken==user_token)&&(e+="<p class='whisper'>",e+="<span class='message-time'>"+a+"</span> ",e+="<a style='text-decoration:none;'><span class='message-author author-linkback' style='color:#"+s.authorColor+";'>",e+=s.author,e+="</span></a>",e+="<span class='glyphicon glyphicon-chevron-right'></span> ",e+="<a style='text-decoration:none;'><span class='message-author author-linkback' style='color:#"+s.destinationColor+";'>",e+=s.destination,e+="</span></a> : ",e+=s.content,e+="</p>")}$("#body-chat").append(e),window.chatHovered||$("#body-chat").scrollTop($("#body-chat")[0].scrollHeight)}$(document).ready(function(){}).on("focus",".chatbox",function(){var s=getBoxToken();getUserList(s),$(this).keypress(function(e){13===e.which&&sendMessage(s,1,null,"chatbox","")})}).on("click",".whisper-action",function(){var s=$("#user-card-name").text();$(".chatbox").val("!w "+s+" "),$(".chatbox").focus()}).on("click","#user-card-close",function(){$(".user-card").remove()});